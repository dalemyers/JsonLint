name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get version from tag
      id: get_version
      run: echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        body: |
          JsonLint ${{ steps.get_version.outputs.version }}

          ## Installation

          Download the appropriate binary for your platform below.

          ### macOS
          ```bash
          # Apple Silicon (M1/M2/M3)
          curl -L -o jsonlint https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/jsonlint-macos-arm64
          chmod +x jsonlint

          # Intel
          curl -L -o jsonlint https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/jsonlint-macos-x86_64
          chmod +x jsonlint
          ```

          ### Linux
          ```bash
          curl -L -o jsonlint https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/jsonlint-linux-x86_64
          chmod +x jsonlint
          ```

          ### Windows
          ```powershell
          Invoke-WebRequest -Uri "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/jsonlint-windows-x86_64.exe" -OutFile "jsonlint.exe"
          ```
        draft: false
        prerelease: false

  build-macos-arm64:
    name: Build macOS ARM64
    needs: create-release
    runs-on: macos-14  # M1 runner

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Swift
      uses: swift-actions/setup-swift@v2
      with:
        swift-version: '6.0'

    - name: Build release binary
      run: |
        swift build -c release --arch arm64
        cp .build/release/jsonlint jsonlint-macos-arm64
        strip jsonlint-macos-arm64

    - name: Test binary
      run: |
        echo '{"test": true}' | ./jsonlint-macos-arm64 --stdin

    - name: Upload binary
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./jsonlint-macos-arm64
        asset_name: jsonlint-macos-arm64
        asset_content_type: application/octet-stream

  build-macos-x86_64:
    name: Build macOS x86_64
    needs: create-release
    runs-on: macos-13  # Intel runner

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Swift
      uses: swift-actions/setup-swift@v2
      with:
        swift-version: '6.0'

    - name: Build release binary
      run: |
        swift build -c release --arch x86_64
        cp .build/release/jsonlint jsonlint-macos-x86_64
        strip jsonlint-macos-x86_64

    - name: Test binary
      run: |
        echo '{"test": true}' | ./jsonlint-macos-x86_64 --stdin

    - name: Upload binary
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./jsonlint-macos-x86_64
        asset_name: jsonlint-macos-x86_64
        asset_content_type: application/octet-stream

  build-linux-x86_64:
    name: Build Linux x86_64
    needs: create-release
    runs-on: ubuntu-latest
    container:
      image: swift:6.0

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        apt-get update
        apt-get install -y libsqlite3-dev

    - name: Build release binary
      run: |
        swift build -c release
        cp .build/release/jsonlint jsonlint-linux-x86_64
        strip jsonlint-linux-x86_64

    - name: Test binary
      run: |
        echo '{"test": true}' | ./jsonlint-linux-x86_64 --stdin

    - name: Upload binary
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./jsonlint-linux-x86_64
        asset_name: jsonlint-linux-x86_64
        asset_content_type: application/octet-stream

  build-windows-x86_64:
    name: Build Windows x86_64
    needs: create-release
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Swift
      uses: compnerd/gha-setup-swift@main
      with:
        branch: swift-6.0-release
        tag: 6.0-RELEASE

    - name: Build release binary
      shell: cmd
      run: |
        swift build -c release
        copy .build\release\jsonlint.exe jsonlint-windows-x86_64.exe

    - name: Test binary
      shell: cmd
      run: |
        echo {"test": true} | jsonlint-windows-x86_64.exe --stdin
      continue-on-error: true

    - name: Upload binary
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ needs.create-release.outputs.upload_url }}
        asset_path: ./jsonlint-windows-x86_64.exe
        asset_name: jsonlint-windows-x86_64.exe
        asset_content_type: application/octet-stream

  publish-homebrew:
    name: Update Homebrew Formula
    needs: [create-release, build-macos-arm64, build-macos-x86_64]
    runs-on: macos-latest
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Generate Homebrew formula
      run: |
        VERSION="${GITHUB_REF#refs/tags/v}"
        cat > jsonlint.rb << EOF
        class Jsonlint < Formula
          desc "JSON linter and formatter supporting JSON, JSON5, and JSONC"
          homepage "https://github.com/${{ github.repository }}"
          version "${VERSION}"

          if Hardware::CPU.arm?
            url "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/jsonlint-macos-arm64"
            sha256 "$(shasum -a 256 jsonlint-macos-arm64 | cut -d' ' -f1)"
          else
            url "https://github.com/${{ github.repository }}/releases/download/v${VERSION}/jsonlint-macos-x86_64"
            sha256 "$(shasum -a 256 jsonlint-macos-x86_64 | cut -d' ' -f1)"
          end

          def install
            bin.install "jsonlint-macos-arm64" => "jsonlint" if Hardware::CPU.arm?
            bin.install "jsonlint-macos-x86_64" => "jsonlint" if Hardware::CPU.intel?
          end

          test do
            output = shell_output("echo '{\"test\": true}' | #{bin}/jsonlint --stdin")
            assert_match "No issues found", output
          end
        end
        EOF
        cat jsonlint.rb

    - name: Save formula as artifact
      uses: actions/upload-artifact@v3
      with:
        name: homebrew-formula
        path: jsonlint.rb
        retention-days: 90
